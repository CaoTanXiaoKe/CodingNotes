#### TCP的报头结构

#### flags的各位

- URG：当 URG = 1 时， 表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据），而不要按照原来的排队顺序来传送。 
- ACK: 仅当 ACK = 1 时确认号字段才有效。 当 ACK = 0 时， 确认号无效。 TCP规定，在连接建立后所有传送的报文段都必须把 ACK 置 1. 
- PSH: 发送方 TCP 把 PSH 置 1， 并立即创建一个报文段发送出去。接收方 TCP 收到 PSH = 1的报文段， 就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上提交。 
- RST: 必须释放连接，然后再重新建立运输连接。 RST 置 1 还用来拒绝一个非法的报文段或拒绝打开一个连接。
- SYN: 在连接建立时用来同步序号。当 SYN = 1 而 ACK = 0 时，表明这是一个连接请求报文段。对方若同意建立连接，则应在相应的报文段中使 SYN = 1 和 ACK = 1. 因此，SYN 置为 1 就表示这是一个请求连接或连接接受报文。 
- FIN: 用于释放一个连接。 当 FIN = 1 时，表明此报文段的发送方数据已发送完毕，并要求释放运输连接。 

#### 滑动窗口

窗口主要是用来加速数据传输和进行流量控制的。 
- 加快数据传输：TCP要可靠传输，所以它需要对一个数据包进行确认，表示接收端收到了数据包。 有了滑动窗口，发送端在发送完一个数据包后，就可以在它的确认还没到达时，发送后面的其他数据包。前提是发送的数据序列号不能超过窗口。 

- 进行流量控制：通过在ACK是告知发送端接收端窗口的大小（即通过调整窗口大小来告知对方，接收端能处理的数据量）。 

#### 正常关闭时的FIN

[TCP的建立与关闭](https://caotanxiaoke.github.io/CaoTanXiaoKe.github.io/2017/04/15/unp-tcp/)

正常关闭时，关闭端会发送FIN分节， 这种情况是根据缓冲区的顺序来发送的，也就是说FIN包放到当前缓冲区末尾，等缓冲区FIN前面的包都发送完后，再发送FIN包。 注意，RST的情况不是这样的。

#### RST标志位
RST(reset)表示复位，是用来异常的关闭连接的。 和FIN不同的是，在发送RST包关闭连接时，不必等缓冲区的包都发送出去，而是直接丢弃缓冲区的包发送RST包。而接收端接收到RST包后，也不必发送ACK包进行确认。 

#### 产生 RST 的条件
在三种情况下会产生RST, 满足三种条件中的任一一条都可以会产生RST:
1. **目的地为某端口的SYN到达，然而该端口上没有正在监听的服务器。**
例如客户端进程向服务器端发送一个SYN请求，想要建立telnet服务，结果服务器端并没有开通这项服务，或者目标端口不对。 这时服务器端就会发送一个RST. 

2. **TCP想取消一个已有连接。**
	
3. **TCP接收到一个根本不存在的连接上的分节。** 
> 导致“Connect reset”(RST) 的原因可能时服务器因为某种原因关闭了Connection, 而客户端依然在读写数据，此时服务器会返回复位标志“RST”, 然后此时客户端就会提示：“Connect reset”。 

另一种比较常见的错误是“Connect reset by peer”， 这个错误和“Connection reset” 还是有区别的：

- 服务器返回了“RST”时，如果此时客户端正在从Sockect套接字的输出流中读数据则会提示“Connection reset”; 

- 服务器返回了“RST”时， 如果此时客户端正在往Socket套接字的输入流中写数据则会提示“Connect reset by peer”. 


